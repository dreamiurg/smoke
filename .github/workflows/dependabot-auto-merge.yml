name: Auto-merge Dependabot PRs

on:
  # Dependabot-triggered workflows get a read-only token + no secrets, even under
  # pull_request_target. Running on workflow_run lets us merge after CI succeeds
  # with normal repo permissions.
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    steps:
      - name: Extract PR number
        id: pr
        run: |
          PR_NUMBER=$(jq -r '.workflow_run.pull_requests[0].number // empty' "$GITHUB_EVENT_PATH")
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR associated with this CI run; skipping."
            exit 0
          fi
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Check author + decide major/minor
        id: gate
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail

          AUTHOR=$(gh pr view "$PR_NUMBER" --json author --jq '.author.login')
          if [ "$AUTHOR" != "dependabot[bot]" ] && [ "$AUTHOR" != "app/dependabot" ]; then
            echo "Not a Dependabot PR ($AUTHOR); skipping."
            echo "should_merge=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft --jq '.isDraft')
          if [ "$DRAFT" = "true" ]; then
            echo "PR is draft; skipping."
            echo "should_merge=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TITLE=$(gh pr view "$PR_NUMBER" --json title --jq '.title')
          echo "title=$TITLE"

          # Heuristic: if the title has "from X to Y" and both look semver-ish,
          # treat a major bump as manual-review.
          FROM=$(printf '%s' "$TITLE" | sed -nE 's/.* from ([^ ]+) to ([^ ]+).*/\\1/p' | head -n1 || true)
          TO=$(printf '%s' "$TITLE" | sed -nE 's/.* from ([^ ]+) to ([^ ]+).*/\\2/p' | head -n1 || true)

          semver_major() {
            # Accept v1.2.3, 1.2.3, v1.2, 1.2
            printf '%s' "$1" | sed -nE 's/^v?([0-9]+)\\..*/\\1/p'
          }

          FROM_MAJOR=$(semver_major "${FROM:-}" || true)
          TO_MAJOR=$(semver_major "${TO:-}" || true)

          if [ -n "${FROM_MAJOR:-}" ] && [ -n "${TO_MAJOR:-}" ] && [ "$TO_MAJOR" -gt "$FROM_MAJOR" ]; then
            echo "Detected major bump ($FROM -> $TO); leaving for manual review."
            echo "should_merge=false" >> "$GITHUB_OUTPUT"
            echo "major_bump=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_merge=true" >> "$GITHUB_OUTPUT"
          echo "major_bump=false" >> "$GITHUB_OUTPUT"

      - name: Comment on major bumps
        if: ${{ steps.gate.outputs.major_bump == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          gh pr comment "$PR_NUMBER" --body "This looks like a **major version update** (from the title), so I'm not auto-merging it. Please review and merge manually if it looks safe."

      - name: Enable auto-merge (squash)
        if: ${{ steps.gate.outputs.should_merge == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          # Use auto-merge so we don't race Codecov's `codecov/patch` status posting.
          gh pr merge "$PR_NUMBER" --auto --squash --delete-branch
