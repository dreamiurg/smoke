name: Auto-merge Dependabot PRs

on:
  # Dependabot-triggered workflows get a read-only token + no secrets, even under
  # pull_request_target. Running on workflow_run lets us merge after CI succeeds
  # with normal repo permissions.
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  # Backstop: if a PR was opened before this workflow existed (or checks were
  # still pending when CI completed), periodically re-check and enable auto-merge.
  schedule:
    - cron: "17 * * * *" # hourly
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event_name != 'workflow_run' ||
        (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request')
      }}
    steps:
      - name: Enable auto-merge for Dependabot PRs (after required checks pass)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          is_dependabot_author() {
            case "$1" in
              dependabot[bot]|app/dependabot) return 0 ;;
              *) return 1 ;;
            esac
          }

          has_skip_label() {
            # Escape hatch for humans: apply one of these labels to stop auto-merge.
            # (Exact match, one per line.)
            printf '%s\n' "$1" | grep -Eq '^(no-automerge|do-not-merge)$'
          }

          checks_all_good() {
            # Use all checks (not just "required") because some repos donâ€™t have
            # branch protection configured, but we still want to wait for CI + other
            # gates to finish.
            #
            # Exit code 8 means "pending".
            local pr="$1"
            local out rc
            set +e
            out="$(gh pr checks "$pr" --json bucket 2>/dev/null)"
            rc=$?
            set -e

            if [ "$rc" -ne 0 ]; then
              return 1
            fi

            # If there are no checks yet, treat as not-ready.
            if [ "$(jq 'length' <<<"$out")" -eq 0 ]; then
              return 1
            fi

            jq -e 'map(.bucket) | all(. == "pass" or . == "skipping")' <<<"$out" >/dev/null
          }

          enable_automerge() {
            # Use auto-merge so we don't race late status posting (e.g. Codecov).
            gh pr merge "$1" --auto --squash --delete-branch
          }

          maybe_handle_pr() {
            local pr="$1"

            local pr_json author draft mergeable merge_state labels
            pr_json="$(gh pr view "$pr" --json author,isDraft,labels,mergeable,mergeStateStatus --jq '.')"
            author="$(jq -r '.author.login' <<<"$pr_json")"
            draft="$(jq -r '.isDraft' <<<"$pr_json")"
            mergeable="$(jq -r '.mergeable' <<<"$pr_json")"
            merge_state="$(jq -r '.mergeStateStatus' <<<"$pr_json")"
            labels="$(jq -r '.labels[].name? // empty' <<<"$pr_json")"

            if ! is_dependabot_author "$author"; then
              echo "PR #$pr: not Dependabot ($author); skipping"
              return 0
            fi

            if [ "$draft" = "true" ]; then
              echo "PR #$pr: draft; skipping"
              return 0
            fi

            if has_skip_label "$labels"; then
              echo "PR #$pr: has no-automerge/do-not-merge label; skipping"
              return 0
            fi

            if [ "$mergeable" = "CONFLICTING" ]; then
              echo "PR #$pr: merge conflicts; skipping"
              return 0
            fi

            # If the PR is behind the base branch and branch protection requires
            # "up to date" merges, auto-merge will never fire until the branch is updated.
            if [ "$merge_state" = "BEHIND" ]; then
              echo "PR #$pr: behind base branch; requesting update"
              gh api -X PUT "repos/${GITHUB_REPOSITORY}/pulls/${pr}/update-branch" >/dev/null || true
              return 0
            fi

            if ! checks_all_good "$pr"; then
              echo "PR #$pr: checks not all passing yet; skipping"
              return 0
            fi

            echo "PR #$pr: enabling auto-merge"
            enable_automerge "$pr"
          }

          prs=""
          if [ "${GITHUB_EVENT_NAME}" = "workflow_run" ]; then
            prs="$(jq -r '.workflow_run.pull_requests[0].number // empty' "$GITHUB_EVENT_PATH" || true)"
          else
            # Note: list all open PRs and filter by author below, so we handle
            # both app/dependabot and dependabot[bot] (and any future variants).
            prs="$(gh pr list --state open --json number --jq '.[].number' || true)"
          fi

          if [ -z "${prs//$'\n'/}" ]; then
            echo "No Dependabot PRs found."
            exit 0
          fi

          for pr in $prs; do
            maybe_handle_pr "$pr"
          done
